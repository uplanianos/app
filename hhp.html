<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hungry Hungry Pupils</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #a3cef1; }
    canvas { display: block; margin: auto; }
    .controls {
      position: absolute;
      width: 100%;
      bottom: 20px;
      pointer-events: none;
    }
    .btn {
      width: 80px;
      height: 80px;
      font-size: 40px;
      background: rgba(0,0,0,0.3);
      color: white;
      border: none;
      border-radius: 50%;
      pointer-events: auto;
      touch-action: manipulation;
      position: absolute;
    }
    #leftBtn { left: 20px; }
    #rightBtn { right: 20px; }
  </style>
</head>
<body>

<!-- Touch Controls -->
<div class="controls">
  <button id="leftBtn" class="btn">⬅️</button>
  <button id="rightBtn" class="btn">➡️</button>
</div>

<script>
const config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  backgroundColor: '#a3cef1',
  physics: {
    default: 'arcade',
    arcade: { gravity: { y: 300 }, debug: false }
  },
  scene: { preload, create, update }
};

let player, cursors, items;
let score = 0;
let scoreText;
let moveLeft = false;
let moveRight = false;
let moveSpeed = 300;
const MAX_SPEED = 600;
const MIN_SPEED = 100;

let powerBarBg, powerBarFill, speedLabel;

const game = new Phaser.Game(config);

function preload() {
  this.load.spritesheet('dude', 'https://labs.phaser.io/assets/sprites/dude.png', {
    frameWidth: 32, frameHeight: 48
  });

  this.load.image('food', 'https://labs.phaser.io/assets/sprites/apple.png');
  this.load.image('book', 'https://labs.phaser.io/assets/sprites/book.png');
  this.load.image('weed', 'sprites/weed.png');
  this.load.image('chocolate', 'sprites/chocolate.png');
  this.load.image('beer', 'sprites/beer.png');
}

function create() {
  // Player setup
  player = this.physics.add.sprite(config.width / 2, config.height - 100, 'dude');
  player.setCollideWorldBounds(true);

  this.anims.create({ key: 'left', frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }), frameRate: 10, repeat: -1 });
  this.anims.create({ key: 'turn', frames: [ { key: 'dude', frame: 4 } ], frameRate: 20 });
  this.anims.create({ key: 'right', frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }), frameRate: 10, repeat: -1 });

  cursors = this.input.keyboard.createCursorKeys();
  items = this.physics.add.group();

  scoreText = this.add.text(16, 16, 'Score: 0', {
    fontSize: '32px',
    fill: '#000'
  });

  // Power bar + label
  speedLabel = this.add.text(16, 60, 'Velocidad', {
    fontSize: '20px',
    fill: '#000'
  });
  powerBarBg = this.add.rectangle(16, 90, 200, 20, 0x888888).setOrigin(0, 0);
  powerBarFill = this.add.rectangle(16, 90, 200, 20, 0x00ff00).setOrigin(0, 0);

  this.time.addEvent({
    delay: 1000,
    callback: dropItem,
    callbackScope: this,
    loop: true
  });

  this.physics.add.overlap(player, items, collectItem, null, this);

  // Touch control handlers
  document.getElementById('leftBtn').addEventListener('touchstart', () => moveLeft = true);
  document.getElementById('leftBtn').addEventListener('touchend', () => moveLeft = false);
  document.getElementById('rightBtn').addEventListener('touchstart', () => moveRight = true);
  document.getElementById('rightBtn').addEventListener('touchend', () => moveRight = false);
}

function update() {
  if (cursors.left.isDown || moveLeft) {
    player.setVelocityX(-moveSpeed);
    player.anims.play('left', true);
  } else if (cursors.right.isDown || moveRight) {
    player.setVelocityX(moveSpeed);
    player.anims.play('right', true);
  } else {
    player.setVelocityX(0);
    player.anims.play('turn');
  }

  // Update power bar width
  const barWidth = 200 * (moveSpeed / MAX_SPEED);
  powerBarFill.width = Phaser.Math.Clamp(barWidth, 0, 200);
}

function dropItem() {
  const x = Phaser.Math.Between(50, config.width - 50);
  const types = ['food', 'book', 'weed', 'chocolate', 'beer'];
  const type = Phaser.Utils.Array.GetRandom(types);

  const item = items.create(x, 10, type);
  item.setData('type', type);
  item.setVelocityY(200);
}

function collectItem(player, item) {
  const type = item.getData('type');

  if (type === 'food') score += 10;
  else if (type === 'book') score += 20;
  else if (type === 'beer') score -= 10;
  else if (type === 'chocolate') moveSpeed = Math.min(MAX_SPEED, moveSpeed + 25);
  else if (type === 'weed') moveSpeed = Math.max(MIN_SPEED, moveSpeed - 100);

  item.destroy();
  scoreText.setText('Score: ' + score);
}
</script>
</body>
</html>